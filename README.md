# BrainDrive Document Processing Service

[![License](https://img.shields.io/badge/License-MIT%20License-green.svg)](LICENSE)

BrainDrive Document Processing Service is a FastAPI-based microservice for parsing and chunking documents. It serves as the document ingestion component of [BrainDrive's Chat with Documents plugin](https://github.com/BrainDriveAI/BrainDrive-Chat-With-Docs-Plugin), which uses a Retrieval-Augmented Generation (RAG) pipeline.

Can also be run as a standalone document processing API service following Clean Architecture principles. Processes documents and returns structured chunks with metadata. Features built-in authentication for secure deployment while maintaining simplicity for local development.

## üöÄ Quick Start

### 1. Clone and Install
```bash
git clone https://github.com/BrainDriveAI/Document-Processing-Service.git
cd Document-Processing-Service
poetry install
```

### 2. Configure Environment

#### Local Development

Copy `.env.local` ‚Üí `.env`:

```bash
cp .env.local .env
```

At minimum `.env.local` should contain:

```env
# Disable authentication (ONLY for local development)
DISABLE_AUTH=false

# Choose authentication method: api_key, jwt, or disabled
AUTH_METHOD=api_key
```

> ‚ö†Ô∏è `AUTH_API_KEY` and `JWT_SECRET` are automatically generated by the `generate_keys` scripts.

#### Production Deployment

Copy `.env.production` ‚Üí `.env` and update values:

```bash
cp .env.production .env
```

### 3. Generate API Keys
**For Linux/macOS:**
```bash
chmod +x generate_keys.sh
./generate_keys.sh --both
```

**For Windows (PowerShell):**
```powershell
.\generate_keys.ps1 -Both
```

### 4. Run the Service
```bash
poetry run uvicorn app.main:app --reload --host 0.0.0.0 --port 8080
```

### 5. Test the API
```bash
# Without authentication (if auth disabled)
curl -X POST "http://localhost:8000/documents/upload" \
  -F "file=@your-document.pdf"

# With API key (if auth enabled)
curl -X POST "http://localhost:8000/documents/upload" \
  -H "X-API-Key: your-generated-api-key" \
  -F "file=@your-document.pdf"
```

## üîê Authentication & Security

### Authentication Methods
- **API Key**: Simple header-based authentication
- **JWT**: Token-based authentication for integration
- **Disabled**: For local development only

### Auth Key Generation

#### Linux/macOS Users
```bash
# Make script executable
chmod +x generate_keys.sh

# Generate both API key and JWT secret
./generate_keys.sh --both

# Generate only API key
./generate_keys.sh --api-key

# Generate only JWT secret
./generate_keys.sh --jwt-secret

# Custom options
./generate_keys.sh --both --length 128 --env-file .env.production
```

#### Windows Users (PowerShell)
```powershell
# Generate both API key and JWT secret
.\generate_keys.ps1 -Both

# Generate only API key
.\generate_keys.ps1 -ApiKey

# Generate only JWT secret
.\generate_keys.ps1 -JwtSecret

# Custom options
.\generate_keys.ps1 -Both -Length 128 -EnvFile .env.production
```

### Security Best Practices
- ‚úÖ Use `DISABLE_AUTH=false` in production or from other services / clients
- ‚úÖ Store API keys securely (environment variables)
- ‚úÖ Use different keys for development and production
- ‚úÖ Rotate keys periodically
- ‚úÖ Never commit `.env` files to version control

## ‚öôÔ∏è Configuration

### Environment Variables
* `.env.local` ‚Üí minimal template for local development
* `.env.production` ‚Üí full template for production

Example `.env.local`:

```env
DISABLE_AUTH=false
AUTH_METHOD=api_key
DEBUG=true
LOG_LEVEL=DEBUG
```

Example `.env.production`:

```env
DISABLE_AUTH=false
AUTH_METHOD=api_key
AUTH_API_KEY=sk-your-production-api-key
DEBUG=false
LOG_LEVEL=INFO
API_HOST=0.0.0.0
API_PORT=8080
UPLOADS_DIR=/app/data/uploads
```

#### Authentication (Production Required)
```env
# Disable authentication (ONLY for local development)
DISABLE_AUTH=false

# Choose authentication method: api_key, jwt, or disabled
AUTH_METHOD=api_key

# API Key Authentication
AUTH_API_KEY=sk-your-generated-api-key-here

# JWT Authentication (alternative to API key)
JWT_SECRET=your-generated-jwt-secret-here
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=60
```

#### Application Settings
```env
# Core App Settings
DEBUG=false
API_HOST=0.0.0.0
API_PORT=8000
LOG_LEVEL=INFO

# File Processing
UPLOADS_DIR=data/uploads
UPLOAD_MAX_FILE_SIZE=104857600  # 100MB
UPLOAD_MAX_PART_SIZE=52428800   # 50MB

# Document Processing
SPACY_MODEL=en_core_web_sm
MAX_CONCURRENT_PROCESSES=4
PROCESSING_TIMEOUT=300

# Performance
MAX_CONCURRENT_PROCESSES=4
PROCESSING_TIMEOUT=300
```

### Configuration Examples

#### Local Development (`.env`)
```env
# Disable auth for local development
DISABLE_AUTH=true
DEBUG=true
LOG_LEVEL=DEBUG
UPLOADS_DIR=data/uploads
```

#### Production with API Key (`.env`)
```env
# Authentication
DISABLE_AUTH=false
AUTH_METHOD=api_key
AUTH_API_KEY=sk-1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z

# Application
DEBUG=false
LOG_LEVEL=INFO
API_HOST=0.0.0.0
API_PORT=8000

# File processing
UPLOADS_DIR=/app/uploads
UPLOAD_MAX_FILE_SIZE=104857600
```

#### Docker/Cloud Deployment (`.env`)
```env
# Authentication
DISABLE_AUTH=false
AUTH_METHOD=api_key
AUTH_API_KEY=sk-prod-your-secure-api-key-here

# Application
DEBUG=false
LOG_LEVEL=INFO
API_HOST=0.0.0.0
API_PORT=8080

# Cloud-specific paths
UPLOADS_DIR=/tmp/uploads
SPACY_MODEL=en_core_web_sm

# Performance tuning for cloud
MAX_CONCURRENT_PROCESSES=2
PROCESSING_TIMEOUT=180
```

## üìä Project Structure

```
Document-Processing-Service/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ core/                          # Domain layer (business logic)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/              # Business entities
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ value_objects/         # Immutable value objects
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exceptions/            # Domain exceptions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ports/                     # Interfaces/contracts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document_processor.py  # Document processing contract
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth_service.py        # Authentication contract
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ use_cases/                 # Application business rules
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ process_document.py    # Document processing use case
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ authenticate_user.py   # Authentication use case
‚îÇ   ‚îú‚îÄ‚îÄ adapters/                      # External service implementations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ document_processor/        # Document processing adapters
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ token_service/             # Token counting services
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth_service/              # Authentication implementations
‚îÇ   ‚îú‚îÄ‚îÄ api/                           # API layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/                    # API endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ deps.py                    # Dependency injection
‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/                # Cross-cutting concerns
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logging.py                 # Structured logging
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metrics.py                 # Performance metrics
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ middleware/                # Custom middleware
‚îÇ   ‚îú‚îÄ‚îÄ config.py                      # Configuration management
‚îÇ   ‚îî‚îÄ‚îÄ main.py                        # Application entry point
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ docker_deployment.md
‚îú‚îÄ‚îÄ ngnix/
‚îÇ   ‚îú‚îÄ‚îÄ ngnix.conf
‚îÇ   ‚îî‚îÄ‚îÄ conf.d/
‚îÇ       ‚îî‚îÄ‚îÄ braindrive.conf
‚îú‚îÄ‚îÄ prometheus/
‚îÇ   ‚îî‚îÄ‚îÄ prometheus.yml
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ docker-compose.prod.yml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ generate_keys.sh                   # Key generation (Linux/macOS)
‚îú‚îÄ‚îÄ generate_keys.ps1                  # Key generation (Windows)
‚îú‚îÄ‚îÄ pyproject.toml                     # Poetry configuration
‚îú‚îÄ‚îÄ .env.local                         # Environment variables template
‚îú‚îÄ‚îÄ .env.production                    # Environment variables template
‚îî‚îÄ‚îÄ README.md                          # This file
```

## üèóÔ∏è Key Features

### 1. Clean Architecture Compliance
- **Domain Layer**: Pure business logic without external dependencies
- **Ports**: Interfaces defining contracts
- **Adapters**: Implementations of external services
- **Use Cases**: Application-specific business rules

### 2. Document Processing Capabilities
- **Multi-format Support**: PDF, DOCX, DOC, TXT
- **Advanced Chunking**: Hierarchical, semantic, token-based, adaptive
- **Metadata Extraction**: Rich metadata from document structure
- **spaCy Layout Integration**: Sophisticated document understanding

### 3. Secure API Design
- **Authentication**: API Key and JWT support
- **RESTful Endpoints**: Clean, intuitive API design
- **Async Processing**: Handle large documents efficiently
- **Error Handling**: Comprehensive error reporting

### 4. Extensibility
- **Plugin Architecture**: Easy to add new processors
- **Strategy Pattern**: Swappable chunking strategies
- **Configuration-driven**: Flexible processing parameters

## üåê API Endpoints

### Authentication Status
```
GET /                    # Service info (includes auth status)
GET /health             # Health check (no auth required)
GET /docs               # API documentation (no auth required)
GET /metrics            # Prometheus metrics (no auth required)
```

### Document Processing (Authentication Required)
```
POST /documents/upload  # Process document and return chunks
```

### API Usage Examples

#### With API Key
```bash
curl -X POST "http://localhost:8000/documents/upload" \
  -H "X-API-Key: sk-your-api-key-here" \
  -F "file=@document.pdf"
```

#### With JWT Token
```bash
curl -X POST "http://localhost:8000/documents/upload" \
  -H "Authorization: Bearer your-jwt-token-here" \
  -F "file=@document.pdf"
```

#### Response Format
```json
{
  "document_id": "uuid-here",
  "chunks": [
    {
      "id": "chunk-1",
      "text": "Document content...",
      "metadata": {
        "page": 1,
        "position": 0,
        "token_count": 150
      }
    }
  ],
  "metadata": {
    "total_chunks": 5,
    "processing_time": 2.34,
    "document_type": "pdf"
  }
}
```

## üê≥ Docker Support

### Build and Run
```bash
# Build image
docker build -t braindrive-document-ai .

# Run with environment variables
docker run -p 8000:8000 \
  -e DISABLE_AUTH=false \
  -e API_KEY=your-api-key \
  braindrive-document-ai
```

### Docker Compose
```yaml
version: '3.8'
services:
  document-ai:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DISABLE_AUTH=false
      - AUTH_API_KEY=sk-your-generated-api-key
      - LOG_LEVEL=INFO
    volumes:
      - ./data:/app/data
```

## üîß Client Integration

### Python Client Example
```python
import aiohttp
import os

class DocumentProcessingClient:
    def __init__(self, base_url: str, api_key: str):
        self.base_url = base_url.rstrip('/')
        self.api_key = api_key
    
    async def process_document(self, file_path: str) -> dict:
        async with aiohttp.ClientSession() as session:
            with open(file_path, 'rb') as f:
                form = aiohttp.FormData()
                form.add_field('file', f, filename=os.path.basename(file_path))
                
                headers = {'X-API-Key': self.api_key}
                async with session.post(
                    f"{self.base_url}/documents/upload",
                    data=form,
                    headers=headers
                ) as response:
                    return await response.json()

# Usage
client = DocumentProcessingClient(
    base_url="http://localhost:8000",
    api_key="sk-your-api-key"
)
result = await client.process_document("document.pdf")
```

## üöÄ Deployment

### Google Cloud Run
```bash
# Build and push
gcloud builds submit --tag gcr.io/your-project/braindrive-document-ai

# Deploy
gcloud run deploy braindrive-document-ai \
  --image gcr.io/your-project/braindrive-document-ai \
  --platform managed \
  --region us-central1 \
  --set-env-vars DISABLE_AUTH=false,AUTH_API_KEY=your-secure-key
```

### AWS Lambda (with Mangum)
```python
from mangum import Mangum
from src.main import app

handler = Mangum(app)
```

### Kubernetes
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: braindrive-document-ai
spec:
  replicas: 3
  selector:
    matchLabels:
      app: braindrive-document-ai
  template:
    spec:
      containers:
      - name: braindrive-document-ai
        image: your-registry/braindrive-document-ai:latest
        env:
        - name: DISABLE_AUTH
          value: "false"
        - name: AUTH_API_KEY
          valueFrom:
            secretKeyRef:
              name: braindrive-secrets
              key: api-key
```

## üß™ Testing

### Run Tests
```bash
# Install dev dependencies
poetry install --with dev

# Run all tests
poetry run pytest

# Run with coverage
poetry run pytest --cov=src

# Run specific test types
poetry run pytest tests/unit/
poetry run pytest tests/integration/
```

### Test Authentication
```bash
# Test without auth (should fail in production)
curl -X POST "http://localhost:8000/documents/upload" \
  -F "file=@test.pdf"

# Test with valid API key
curl -X POST "http://localhost:8000/documents/upload" \
  -H "X-API-Key: your-api-key" \
  -F "file=@test.pdf"

# Test with invalid API key (should return 401)
curl -X POST "http://localhost:8000/documents/upload" \
  -H "X-API-Key: invalid-key" \
  -F "file=@test.pdf"
```

## üîç Monitoring & Observability

### Structured Logging
- JSON-formatted logs for easy parsing
- Request/response correlation IDs
- Authentication audit logs
- Performance metrics logging

### Metrics (Prometheus)
```bash
# Access metrics endpoint
curl http://localhost:8000/metrics
```

### Health Monitoring
```bash
# Health check (always accessible)
curl http://localhost:8000/health
```

## ü§ù Contributing

1. Fork the repository
2. Create a feature branch: `git checkout -b feature/your-feature`
3. Make changes following clean architecture principles
4. Add tests for new functionality
5. Ensure new feature works correctly
6. Update documentation as needed
7. Submit a pull request

## üìÑ License

This project is licensed under the MIT License - see the LICENSE file for details.

## üÜò Troubleshooting

### Common Issues

**Authentication Errors (401)**
- Verify `DISABLE_AUTH=false` is set correctly
- Check that `AUTH_API_KEY` is set in environment
- Ensure client is sending `X-API-Key` header
- Verify API key matches exactly (no extra spaces)

**Key Generation Issues**
- **Linux/macOS**: Ensure `openssl` is installed or `/dev/urandom` exists
- **Windows**: Run PowerShell as Administrator if needed
- Check script permissions: `chmod +x generate_keys.sh`

**File Upload Errors**
- Check file size limits (`UPLOAD_MAX_FILE_SIZE`)
- Verify file format is supported (PDF, DOCX, DOC, TXT)
- Ensure `UPLOADS_DIR` is writable

**spaCy Model Issues**
```bash
# Install required spaCy model
python -m spacy download en_core_web_sm
```

### Debug Mode
```env
DEBUG=true
LOG_LEVEL=DEBUG
```

This will provide detailed logging for troubleshooting issues.

## ü§ñ For AI Coding Agents

**Start here:** [`FOR-AI-CODING-AGENTS.md`](FOR-AI-CODING-AGENTS.md)

This project has comprehensive documentation for AI coding agents (Claude Code, GitHub Copilot, Cursor, Codeium, etc.):

- **Architecture Guide:** Read `FOR-AI-CODING-AGENTS.md` for Clean Architecture patterns, development commands, and implementation details
- **Knowledge Base:** Check `docs/` before implementing - contains ADRs, failures, data quirks, and integration docs
- **Auto-Compound:** Document your decisions, failures, and discoveries in `docs/` for future developers

**Quick commands:**
```bash
# Search past decisions
grep -r "keyword" docs/decisions/

# Check known mistakes
grep -r "keyword" docs/failures/

# Review quirks/gotchas
grep -r "keyword" docs/data-quirks/
```

**See:** `docs/AI-AGENT-GUIDE.md` for complete compounding engineering workflow.

---

## üîó Related Projects

- [BrainDrive Main Application](https://github.com/BrainDriveAI/BrainDrive-Core) - The primary chat application
- [BrainDrive Chat With Your Documents Service](https://github.com/BrainDriveAI/Document-Chat-Service) - Sofisticated RAG
